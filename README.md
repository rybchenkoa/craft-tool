# Самопал ЧПУ
Проект ЧПУ контроллера. Создан в связи с тем, что существующие на тот момент PC-контроллеры могли терять шаги из-за лагов компьютера. Для работы нужны:
- сама программа
- usb-com переходник
- отладочная плата с микроконтроллером stm32f407* на борту
- программатор (возможна заливка программы и через com переходник)

При 'нехватке пакетов для продолжения движения' контроллер снижает скорость, поэтому в случае изогнутых траекторий с большим количеством отрезков для работы на полной скорости нужно быстрое подключение, 1000 000 бит/сек оптимально для ft232.

## Возможности контроллера
- Непрерывная генерация шагов
- Удалённое подключение (при использовании bluetooth в режиме com-порта)
- Lookahead, траектория склеивается в непрерывную линию без торможений
- Управление скоростью с помощью напряжения на пине
- ШИМ лазера
- Синхронизация со шпинделем
- Работа на Windows XP

## Поддерживаемые коды
- G0, G1, G2, G3 - быстрое, линейное и круговое перемещение
- G4 - пауза в миллисекундах
- G17, G18, G19 - плоскости интерполяции для круговой траектории
- G20, G21 - подача в дюймах/миллиметрах
- G32 - синхронизация со шпинделем
- G53 - введённые координаты считаются аппаратными
- G54..G58 - локальные системы координат
- G80..G83 - циклы сверления
- G90, G91 - инкрементный/абсолютный режим задания координат
- G94 - подача в минуту, задаёт максимальную скорость движения
- G94.1 - прерывистая подача для слабых шпинделей, движение происходит рывками
- G94.2 - управления подачей напряжением, включает/выключает перемножение на напряжение на входном пине
- G95 - подача на оборот, при этом максимальная скорость так же не превышается
- G95.1 - подача со стабилизацией оборотов, запрещает двигаться быстрее, чем шпиндель может выдавать заданные обороты (в Гц)
- G98, G99 - высота отвода инструмента в циклах
- F - подача, мм/мин
- S - ШИМ сигнал для лазера [0..1]
- X, Y, Z, A, B - поддерживаемые координаты

## Настройка
В рабочем каталоге, заданном при запуске программы, должен лежать файл config.cfg. Пример реально используемого конфига можно посмотреть в репозитории.

## Разводка пинов
Актуальная в gpio.h <br/>
STEP [D12, D13, D14, D15, G4] <br/>
DIR  [D10, D11, G2,  G3,  G6] <br/>
ШИМ низкочастотный [E8, E10, E12] <br/>
ШИМ аппаратный     [E9, E11, E13, E14] <br/>
входы [C11, C12, D0, D1, D2, D3, D4, D5] <br/>
ADC   [F3] <br/>

## Ручное управление
- <kbd>←</kbd><kbd>→</kbd> - X
- <kbd>↑</kbd><kbd>↓</kbd> - Y
- <kbd>W</kbd><kbd>S</kbd> - Z
- <kbd>R</kbd><kbd>F</kbd> - A
- <kbd>T</kbd><kbd>G</kbd> - B
- <kbd>Ctrl</kbd> - шаг*10
- <kbd>Shift</kbd> - быстрое перемещение со страховкой
